#!/usr/bin/env sh
#
# a simple dmenu mocp script to select song from playlist by
# zordsdavini, 2016
# Cyril Augier, 2019
#
###

# TODO: I don't know why grep gives in DOS format – removed it with `tr`

# check mocp is running
rez=$(mocp -i | grep -E ^State | cut -d ":" -f2 | cut -c 2-)
case $rez in
	PLAY|PAUSE|STOP) ;;
	*) mocp -S;;
esac

# format dmenu
DMENU() {
	# For very large playlists, set a fixed value of 50 (lines).
	# Otherwise, some songs may be off screen.
	if [ "$1" -gt 50 ]; then
		lines=50
	fi
	dmenu -i -p → -fn "Andika-8" -nb "#15181a" -nf "#00ff00" -sb "#079822" -sf "#fff" -h "24" -l "$lines"
}

# get playlist
playlist=$(grep -u -E "^[^#]" ~/.moc/playlist.m3u | tr -d "\015")

# get number of songs in playlist
lines=$(printf "%s\n" "$playlist" | wc -l)

# select songs from existing playlist (generated by MOC)
choice=$(printf "%s" "$playlist" | DMENU "$lines")

# play selected song. If error it will do nothing
if [ -n "$choice" ]; then
	mocp -l "$choice"
fi
